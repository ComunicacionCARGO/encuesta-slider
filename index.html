<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>¬øC√≥mo arrancamos la semana?</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600;800&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      background-color: #F2F2F2;
      color: #0D2334;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    canvas#ballpit {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: auto;
    }

    h1 {
      color: #D71F36;
      font-weight: 800;
    }

    h1, p, .slider-container, button, .thanks {
      position: relative;
      z-index: 2;
      text-align: center;
    }

    .slider-container {
      width: 90%; max-width: 600px;
      height: 100px;
      position: relative;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 15px;
      border-radius: 10px;
      background: linear-gradient(to right, #0DB4C3, #3DAA37, #F6D21A, #EF8314, #D71F36);
      outline: none;
      position: absolute;
      top: 50%; transform: translateY(-50%);
      z-index: 1;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 60px; height: 60px;
      background: transparent; border: none;
      cursor: grab;
      pointer-events: auto;
      position: relative;
      z-index: 3;
    }

    .emoji-thumb {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%) scale(1);
      font-size: 2rem;
      transition: transform 0.2s ease;
      z-index: 2;
      pointer-events: none;
    }

    .emoji-thumb.hovered {
      transform: translate(-50%, -50%) scale(1.3);
    }

    button {
      padding: 10px 20px;
      font-size: 1rem;
      background-color: #D71F36;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      z-index: 2;
    }

    .thanks {
      display: none;
      font-size: 1.2rem;
      margin-top: 1rem;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Panel de administrador */
    .admin-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      z-index: 1000;
      display: none;
    }

    .admin-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      background: transparent;
      border: none;
      color: transparent;
      font-size: 1px;
      width: 20px;
      height: 20px;
      z-index: 1001;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Bot√≥n invisible para acceder al panel de admin -->
  <button class="admin-toggle" onclick="toggleAdmin()" title="Admin">¬∑</button>

  <!-- Panel de administrador -->
  <div class="admin-panel" id="adminPanel">
    <strong>üìä Resumen de Respuestas:</strong>
    <div id="statsDisplay"></div>
    <button onclick="exportarDatos()" style="margin-top: 5px; font-size: 0.7rem;">Exportar CSV</button>
    <button onclick="limpiarDatos()" style="margin-top: 5px; font-size: 0.7rem; background: #666;">Limpiar</button>
  </div>

  <canvas id="ballpit"></canvas>

  <h1>¬øC√≥mo arrancamos la semana?</h1>
  <p>Del 1 al 10, ¬øqu√© tan motivado est√°s para encarar la semana?</p>

  <div class="slider-container">
    <input type="range" min="0" max="10" value="5" step="0.01" id="moodSlider">
    <div class="emoji-thumb" id="thumbEmoji">üòê</div>
  </div>

  <button id="submitBtn" onclick="enviar()">Enviar</button>
  <div class="thanks" id="thanks">¬°Gracias por sumarte a arrancar con energ√≠a! üöÄ</div>

  <script>
    const slider = document.getElementById("moodSlider");
    const thumbEmoji = document.getElementById("thumbEmoji");
    const caras = ["üò¨", "üôÅ", "üòü", "‚òπÔ∏è", "üòê", "üôÇ", "üòå", "üòä", "üòÑ", "üî•", "üöõ"];

    // Variables globales para datos en memoria (sin localStorage)
    let respuestas = [];
    let userSubmitted = false;

    function updateEmoji() {
      const val = +slider.value;
      const pct = val / 10;
      thumbEmoji.textContent = caras[Math.round(val)];
      thumbEmoji.style.left = `calc(${pct * 100}% + ${8 - pct * 16}px)`;
      thumbEmoji.style.fontSize = `${30 + pct * 40}px`;
    }

    slider.addEventListener("input", updateEmoji);
    slider.addEventListener("mousemove", updateEmoji);
    window.addEventListener("resize", updateEmoji);
    updateEmoji();

    slider.addEventListener("mouseenter", () => {
      thumbEmoji.classList.add("hovered");
    });

    slider.addEventListener("mouseleave", () => {
      thumbEmoji.classList.remove("hovered");
    });

    // Funciones de almacenamiento compatibles
    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        // Si localStorage no funciona, usar variables globales
        if (key === 'mood_responses') {
          respuestas = JSON.parse(value);
        } else if (key === 'user_submitted_today') {
          userSubmitted = true;
        }
        return true;
      }
    }

    function safeGetItem(key) {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        // Si localStorage no funciona, usar variables globales
        if (key === 'mood_responses') {
          return JSON.stringify(respuestas);
        } else if (key === 'user_submitted_today') {
          return userSubmitted ? new Date().toDateString() : null;
        }
        return null;
      }
    }

    // Funci√≥n para guardar respuesta
    function guardarRespuesta(mood) {
      const timestamp = Date.now();
      const fecha = new Date().toLocaleString('es-AR');
      
      const entrada = {
        id: timestamp,
        fecha: fecha,
        mood: mood,
        timestamp: timestamp
      };

      // Obtener respuestas existentes
      let respuestasActuales = JSON.parse(safeGetItem('mood_responses') || '[]');
      
      // Agregar nueva respuesta
      respuestasActuales.push(entrada);
      
      // Guardar de vuelta
      safeSetItem('mood_responses', JSON.stringify(respuestasActuales));
      
      return true;
    }

    // Funci√≥n principal de env√≠o
    async function enviar() {
      // Verificar si ya se envi√≥
      const yaEnviado = safeGetItem('user_submitted_today');
      const hoy = new Date().toDateString();
      
      if (yaEnviado === hoy) {
        alert("¬°Ya enviaste tu respuesta!");
        return;
      }

      const submitBtn = document.getElementById("submitBtn");
      const thanks = document.getElementById("thanks");

      // Mostrar estado de carga
      submitBtn.textContent = "Enviando...";
      submitBtn.classList.add("loading");

      try {
        const mood = Math.round(+slider.value);
        
        // Guardar respuesta
        const guardado = guardarRespuesta(mood);
        
        if (guardado) {
          // Marcar como enviado
          safeSetItem('user_submitted_today', hoy);
          
          // Ocultar formulario y mostrar agradecimiento
          slider.disabled = true;
          submitBtn.style.display = "none";
          thanks.style.display = "block";
          
          // Activar explosi√≥n de emojis
          triggerExplosion();
          
          // Actualizar estad√≠sticas si el panel est√° visible
          actualizarStats();
          
          console.log("Respuesta guardada correctamente");
          
          // Cerrar ventana autom√°ticamente despu√©s de 3 segundos si es popup
          setTimeout(() => {
            if (window.opener) {
              window.close();
            }
          }, 3000);
          
        } else {
          throw new Error("Error al guardar la respuesta");
        }

      } catch (error) {
        console.error("Error al enviar datos:", error);
        alert("Hubo un error al enviar tu respuesta. Por favor, intenta nuevamente.");
        
        // Restaurar bot√≥n
        submitBtn.textContent = "Enviar";
        submitBtn.classList.remove("loading");
      }
    }

    // === FUNCIONES DE ADMINISTRADOR ===
    
    function toggleAdmin() {
      const panel = document.getElementById('adminPanel');
      if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        actualizarStats();
      } else {
        panel.style.display = 'none';
      }
    }

    function actualizarStats() {
      const respuestasData = JSON.parse(safeGetItem('mood_responses') || '[]');
      const statsDiv = document.getElementById('statsDisplay');
      
      if (respuestasData.length === 0) {
        statsDiv.innerHTML = '<div>No hay respuestas a√∫n</div>';
        return;
      }

      // Calcular estad√≠sticas b√°sicas
      const total = respuestasData.length;
      const suma = respuestasData.reduce((acc, r) => acc + r.mood, 0);
      const promedio = (suma / total).toFixed(1);
      
      // Contar por nivel de √°nimo
      const conteos = {};
      respuestasData.forEach(r => {
        conteos[r.mood] = (conteos[r.mood] || 0) + 1;
      });

      let html = `
        <div>Total respuestas: ${total}</div>
        <div>Promedio: ${promedio}/10</div>
        <div style="margin-top: 5px; font-size: 0.7rem;">
      `;
      
      for (let i = 0; i <= 10; i++) {
        if (conteos[i]) {
          html += `<div>${i}: ${conteos[i]} ${caras[i]}</div>`;
        }
      }
      
      html += '</div>';
      statsDiv.innerHTML = html;
    }

    function exportarDatos() {
      const respuestasData = JSON.parse(safeGetItem('mood_responses') || '[]');
      
      if (respuestasData.length === 0) {
        alert('No hay datos para exportar');
        return;
      }

      // Crear CSV simple
      let csv = 'Fecha,Estado_Animo\n';
      respuestasData.forEach(r => {
        csv += `"${r.fecha}",${r.mood}\n`;
      });

      // Descargar
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'mood-data-' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function limpiarDatos() {
      if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos?')) {
        try {
          localStorage.removeItem('mood_responses');
          localStorage.removeItem('user_submitted_today');
        } catch (e) {
          // Si localStorage no funciona, limpiar variables globales
          respuestas = [];
          userSubmitted = false;
        }
        actualizarStats();
        alert('Datos eliminados');
      }
    }

    // === BALLPIT ANIMATION ===
    
    const canvas = document.getElementById("ballpit");
    const ctx = canvas.getContext("2d");
    let w, h;
    const balls = [];
    const emojis = [];
    const mouse = { x: -9999, y: -9999 };

    function resize() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
    }

    function createBalls(n = 60) {
      balls.length = 0; // Limpiar array primero
      for (let i = 0; i < n; i++) {
        balls.push({
          x: Math.random() * w,
          y: Math.random() * h,
          r: 8 + Math.random() * 12,
          vx: (Math.random() - 0.5) * 1.5,
          vy: (Math.random() - 0.5) * 1.5,
          color: ["#D71F36", "#0DB4C3", "#3DAA37", "#F6D21A", "#EF8314"][Math.floor(Math.random() * 5)]
        });
      }
    }

    function triggerExplosion() {
      const val = Math.round(+slider.value);
      const emoji = caras[val];
      for (let i = 0; i < 30; i++) {
        emojis.push({
          x: w / 2,
          y: h / 2,
          vx: (Math.random() - 0.5) * 10,
          vy: (Math.random() - 0.5) * 10,
          life: 100,
          char: emoji
        });
      }
    }

    function animate() {
      ctx.clearRect(0, 0, w, h);

      // Animar bolas
      for (let b of balls) {
        // Ruido aleatorio
        b.vx += (Math.random() - 0.5) * 0.2;
        b.vy += (Math.random() - 0.5) * 0.2;

        // Repulsi√≥n del mouse
        const dx = b.x - mouse.x;
        const dy = b.y - mouse.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < 200) {
          const f = (200 - dist) / 200;
          b.vx += dx / dist * f * 2.5;
          b.vy += dy / dist * f * 2.5;
        }

        // Actualizar posici√≥n
        b.x += b.vx;
        b.y += b.vy;

        // Rebotar en bordes
        if (b.x < b.r || b.x > w - b.r) {
          b.vx *= -0.8;
          b.x = Math.max(b.r, Math.min(w - b.r, b.x));
        }
        if (b.y < b.r || b.y > h - b.r) {
          b.vy *= -0.8;
          b.y = Math.max(b.r, Math.min(h - b.r, b.y));
        }

        // Fricci√≥n
        b.vx *= 0.93;
        b.vy *= 0.93;

        // Dibujar bola
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
        ctx.fillStyle = b.color;
        ctx.fill();
      }

      // Animar emojis de explosi√≥n
      for (let i = emojis.length - 1; i >= 0; i--) {
        const emoji = emojis[i];
        ctx.font = "32px sans-serif";
        ctx.globalAlpha = emoji.life / 100;
        ctx.fillText(emoji.char, emoji.x, emoji.y);
        ctx.globalAlpha = 1;
        emoji.x += emoji.vx;
        emoji.y += emoji.vy;
        emoji.life--;
        if (emoji.life <= 0) emojis.splice(i, 1);
      }

      requestAnimationFrame(animate);
    }

    // Event listeners
    canvas.addEventListener("mousemove", e => {
      const rect = canvas.getBoundingClientRect();
      mouse.x = e.clientX - rect.left;
      mouse.y = e.clientY - rect.top;
    });

    window.addEventListener("resize", () => {
      resize();
      createBalls();
    });
    
    // Verificar si ya se envi√≥ al cargar la p√°gina
    const yaEnviado = safeGetItem('user_submitted_today');
    const hoy = new Date().toDateString();
    
    if (yaEnviado === hoy) {
      slider.disabled = true;
      document.getElementById("submitBtn").style.display = "none";
      document.getElementById("thanks").style.display = "block";
    }

    // Inicializar
    resize();
    createBalls();
    animate();
  </script>

</body>
</html>
